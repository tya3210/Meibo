<!DOCTYPE html>
<html>
<head>
<title>部活動出欠管理</title>
<meta charset="UTF-8">
<style>
body { font-family: sans-serif; }
h1, h2 { text-align: center; }
table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
th, td { border: 1px solid black; padding: 8px; text-align: center; }
th { background-color: #f0f0f0; }
.button-container { text-align: center; margin-bottom: 20px; }
button { padding: 10px 20px; font-size: 16px; cursor: pointer; }
#addMemberSection { display: none; margin-bottom: 20px; border: 1px solid #ccc; padding: 15px; }
#addMemberSection h2 { margin-top: 0; }
#addMemberSection input[type="text"], #addMemberSection input[type="password"] { width: calc(100% - 22px); padding: 8px; margin-bottom: 10px; border: 1px solid #ccc; }
.attendance-checkbox { transform: scale(1.5); }
#instrumentSection { margin-bottom: 20px; text-align: center; }
#attendanceSection { display: none; position: relative; }
.back-button-container { position: absolute; top: 10px; left: 10px; text-align: left; margin-bottom: 10px; }
.back-button-container button { padding: 8px 15px; font-size: 14px; }
.member-item { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
.member-item button { margin-left: 10px; }
.edit-input { width: calc(60% - 20px); padding: 8px; border: 1px solid #ccc; }
#memberList { margin-bottom: 15px; }
#memberList li { margin-bottom: 8px; }
#absentMemberListSection { text-align: left; margin-top: 20px; padding: 10px; border: 1px solid #ddd; border-radius: 5px; }
#absentMemberList { list-style-type: none; padding-left: 0; }
#absentMemberList li { margin-bottom: 5px; }
.instrument-label { display: inline-block; width: 60px; text-align: right; margin-right: 10px; } /* 楽器名ラベル用 */
</style>
</head>
<body>

<h1>[あなたの部活動名] 出欠管理</h1>

<div id="instrumentSection">
    <h2>楽器を選択してください</h2>
    <select id="instrumentSelect">
        <option value="">楽器を選択</option>
        <option value="フルート">フルート</option>
        <option value="クラリネット">クラリネット</option>
        <option value="オーボエ">オーボエ</option>
        <option value="サックス">サックス</option>
        <option value="トランペット">トランペット</option>
        <option value="ホルン">ホルン</option>
        <option value="トロンボーン">トロンボーン</option>
        <option value="ユーフォニアム">ユーフォニアム</option>
        <option value="コントラバス">コントラバス</option>
        <option value="チューバ">チューバ</option>
        <option value="パーカッション">パーカッション</option>
    </select>
    <button onclick="selectInstrument()">決定</button>

    <div id="absentMemberListSection">
        <h2>欠席者</h2>
        <ul id="absentMemberList">
            </ul>
    </div>
</div>

<div id="attendanceSection">
    <div class="back-button-container">
        <button onclick="goToInstrumentSection()">楽器選択に戻る</button>
    </div>

    <div id="addMemberSection">
        <h2>メンバー追加・編集 (管理者用)</h2>
        <input type="password" id="adminPassword" placeholder="管理者パスワード">
        <button onclick="checkAdminPassword()">認証</button>
        <div id="addMemberForm" style="display: none;">
            <div class="input-group">
                <label for="newMemberInstrument" class="instrument-label">楽器:</label>
                <input type="text" id="newMemberInstrument" placeholder="楽器名">
            </div>
            <div class="input-group">
                <label for="newMemberName" class="instrument-label">名前:</label>
                <input type="text" id="newMemberName" placeholder="新しいメンバー名">
            </div>
            <button onclick="addMember()">メンバー追加</button>
            <ul id="memberList"></ul>
            <button onclick="saveMembers()">メンバーリストを保存</button>
        </div>
    </div>

    <div class="button-container">
        <button onclick="toggleAddMemberSection()">メンバー追加・編集</button>
    </div>

    <h2>出欠状況 (本日: <span id="todayDate"></span>)  - <span id="selectedInstrumentDisplay"></span></h2>

    <table id="attendanceTable">
        <thead>
            <tr>
                <th>名前</th>
                <th>出席</th>
                <th>欠席</th>
            </tr>
        </thead>
        <tbody id="attendanceTableBody">
            </tbody>
    </table>

    <div class="button-container">
        <button onclick="updateAttendance()">出欠を更新</button>
    </div>

</div>

<script>
const adminPass = "Brassband";
let adminMode = false;
let members = [];
let attendanceData = [];
let selectedInstrument = "";

document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('instrumentSection').style.display = 'block';
    document.getElementById('attendanceSection').style.display = 'none';
});

function initializeAttendancePage() {
    updateTodayDate();
    loadMembers();
    loadAttendance();
    renderAttendanceTable();
    updateInstrumentDisplay(); // 楽器名表示を更新
}

function updateInstrumentDisplay() {
    const instrumentDisplaySpan = document.getElementById('selectedInstrumentDisplay');
    instrumentDisplaySpan.textContent = `(${selectedInstrument})`; // 選択された楽器名を表示
}


function loadInstrumentPreference() {
    selectedInstrument = localStorage.getItem('selectedInstrument');
}

function saveInstrumentPreference() {
    localStorage.setItem('selectedInstrument', selectedInstrument);
}

function selectInstrument() {
    const instrumentSelect = document.getElementById('instrumentSelect');
    selectedInstrument = instrumentSelect.value;
    if (selectedInstrument) {
        saveInstrumentPreference();
        document.getElementById('instrumentSection').style.display = 'none';
        document.getElementById('attendanceSection').style.display = 'block';
        initializeAttendancePage();
        updateAbsentMemberList();
    } else {
        alert('楽器を選択してください。');
    }
}

function goToInstrumentSection() {
    document.getElementById('instrumentSection').style.display = 'block';
    document.getElementById('attendanceSection').style.display = 'none';
    updateAbsentMemberList();
}


function updateTodayDate() {
    const todaySpan = document.getElementById('todayDate');
    const today = new Date();
    const formattedDate = today.toLocaleDateString('ja-JP', { month: 'numeric', day: 'numeric' });
    todaySpan.textContent = formattedDate;
}

function toggleAddMemberSection() {
    const section = document.getElementById('addMemberSection');
    section.style.display = section.style.display === 'none' ? 'block' : 'none';
    const form = document.getElementById('addMemberForm');
    form.style.display = 'none';
}

function checkAdminPassword() {
    const passwordInput = document.getElementById('adminPassword');
    const form = document.getElementById('addMemberForm');
    if (passwordInput.value === adminPass) {
        form.style.display = 'block';
        loadMemberList();
        passwordInput.value = '';
        alert('管理者モードになりました。');
        adminMode = true;
    } else {
        alert('パスワードが違います。');
        form.style.display = 'none';
        adminMode = false;
    }
}


function loadMembers() {
    const storedMembers = localStorage.getItem('members');
    if (storedMembers) {
        members = JSON.parse(storedMembers);
    } else {
        members = [  // 初期メンバーリストを更新 - 楽器情報を含む
            { name: "メンバー1", instrument: "フルート" },
            { name: "メンバー2", instrument: "フルート" },
            { name: "メンバー3", instrument: "チューバ" },
            { name: "メンバー4", instrument: "チューバ" }
        ];
        saveMembers();
    }
}

function loadMemberList() {
    const memberListUl = document.getElementById('memberList');
    memberListUl.innerHTML = '';

    if (members.length === 0) {
        const listItem = document.createElement('li');
        listItem.textContent = 'メンバーはまだ登録されていません。下のフォームから追加してください。';
        memberListUl.appendChild(listItem);
        return;
    }

    members.forEach((member, index) => {
        const listItem = document.createElement('li');
        listItem.classList.add('member-item');

        // 楽器名表示・編集
        let memberInstrumentSpan = document.createElement('span');
        memberInstrumentSpan.textContent = `楽器: ${member.instrument}`; // 楽器名を表示
        let editInstrumentInput = document.createElement('input');
        editInstrumentInput.type = 'text';
        editInstrumentInput.value = member.instrument;
        editInstrumentInput.className = 'edit-input';
        editInstrumentInput.style.display = 'none';


        // メンバー名表示・編集 (既存部分)
        let memberNameSpan = document.createElement('span');
        memberNameSpan.textContent = `名前: ${member.name}`; // 名前を表示
        let editInput = document.createElement('input');
        editInput.type = 'text';
        editInput.value = member.name;
        editInput.className = 'edit-input';
        editInput.style.display = 'none';


        let editButton = document.createElement('button');
        editButton.textContent = '編集';
        editButton.onclick = function() {
            memberNameSpan.style.display = 'none';
            editInput.style.display = 'inline-block';
            memberInstrumentSpan.style.display = 'none'; // 楽器名も非表示
            editInstrumentInput.style.display = 'inline-block'; // 楽器編集フィールドを表示

            editInput.focus();
        };

        editInput.addEventListener('blur', function() {
            saveEdit(index, editInput.value, editInstrumentInput.value); // saveEditに楽器名も渡す
            memberNameSpan.style.display = 'inline-block';
            editInput.style.display = 'none';
            memberInstrumentSpan.style.display = 'inline-block'; // 楽器名再表示
            editInstrumentInput.style.display = 'none'; // 楽器編集フィールド非表示
        });

        editInput.addEventListener('keydown', function(event) {
            if (event.key === 'Enter') {
                saveEdit(index, editInput.value,  editInstrumentInput.value); // saveEditに楽器名も渡す
                memberNameSpan.style.display = 'inline-block';
                editInput.style.display = 'none';
                memberInstrumentSpan.style.display = 'inline-block'; // 楽器名再表示
                editInstrumentInput.style.display = 'none'; // 楽器編集フィールド非表示
            }
        });

        editInstrumentInput.addEventListener('blur', function() { // 楽器編集フィールドのblurイベント
             saveEdit(index, editInput.value, editInstrumentInput.value); // saveEditに楽器名も渡す
            memberInstrumentSpan.style.display = 'inline-block';
            editInstrumentInput.style.display = 'none';
            memberNameSpan.style.display = 'inline-block'; // メンバー名再表示
            editInput.style.display = 'none'; // メンバー名編集フィールド非表示
        });

        editInstrumentInput.addEventListener('keydown', function(event) { // 楽器編集フィールドのkeydownイベント
            if (event.key === 'Enter') {
                 saveEdit(index, editInput.value,  editInstrumentInput.value); // saveEditに楽器名も渡す
                memberInstrumentSpan.style.display = 'inline-block';
                editInstrumentInput.style.display = 'none';
                memberNameSpan.style.display = 'inline-block'; // メンバー名再表示
                editInput.style.display = 'none'; // メンバー名編集フィールド非表示
            }
        });


        let deleteButton = document.createElement('button');
        deleteButton.textContent = '削除';
        deleteButton.onclick = function() { deleteMember(index); };

        listItem.appendChild(memberNameSpan);
        listItem.appendChild(editInput);
        listItem.appendChild(memberInstrumentSpan); // 楽器名表示
        listItem.appendChild(editInstrumentInput); // 楽器名編集フィールド
        listItem.appendChild(deleteButton);
        memberListUl.appendChild(listItem);
    });
}

function saveEdit(index, newName, newInstrument) { // 引数にnewInstrumentを追加
    if (!adminMode) {
        alert('管理者モードでのみ編集可能です。');
        return;
    }
    if (newName.trim() && newInstrument.trim() && !members.some((m, i) => m.name === newName.trim() && i !== index )) {
        members[index] = { name: newName.trim(), instrument: newInstrument.trim() }; // 楽器名も保存
        saveMembers();
        loadMemberList();
        renderAttendanceTable();
        alert('メンバー情報を変更しました。'); // メッセージを更新
    } else if (!newName.trim() || !newInstrument.trim()) {
        alert('メンバー名と楽器名を入力してください。'); // アラートメッセージを修正
        loadMemberList();
    } else if (members.some((m, i) => m.name === newName.trim() && i !== index )) {
        alert('そのメンバー名は既に登録されています。');
        loadMemberList();
    }
}


function addMember() {
    if (!adminMode) {
        alert('管理者モードでのみメンバー追加が可能です。');
        return;
    }
    const newMemberNameInput = document.getElementById('newMemberName');
    const newMemberInstrumentInput = document.getElementById('newMemberInstrument'); // 楽器名入力欄を取得
    const newMemberName = newMemberNameInput.value.trim();
    const newMemberInstrument = newMemberInstrumentInput.value.trim(); // 楽器名を取得

    if (newMemberName && newMemberInstrument && !members.some(m => m.name === newMemberName)) { // 楽器名が空でないこともチェック
        members.push({ name: newMemberName, instrument: newMemberInstrument }); // メンバーオブジェクトに楽器名も追加
        newMemberNameInput.value = '';
        newMemberInstrumentInput.value = ''; // 楽器名入力欄もクリア
        saveMembers();
        loadMemberList();
        renderAttendanceTable();
        alert(newMemberName + ' さんを' + newMemberInstrument + 'パートとして追加しました。'); // メッセージを更新
    } else if (!newMemberName) {
        alert('メンバー名を入力してください。');
    } else if (!newMemberInstrument) { // 楽器名が空の場合のアラート
        alert('楽器名を入力してください。');
    }
     else if (members.some(m => m.name === newMemberName)) {
        alert('そのメンバーは既に登録されています。');
    }
}

function deleteMember(index) {
    if (!adminMode) {
        alert('管理者モードでのみメンバー削除が可能です。');
        return;
    }
    if (confirm(members[index].name + ' さんを削除してもよろしいですか？')) { // メンバー名を表示するように修正
        members.splice(index, 1);
        saveMembers();
        loadMemberList();
        renderAttendanceTable();
        alert('メンバーを削除しました。');
    }
}


function saveMembers() {
    localStorage.setItem('members', JSON.stringify(members));
}


function loadAttendance() {
    const today = getFormattedDate();
    const storedAttendance = localStorage.getItem('attendance_' + today);
    if (!storedAttendance) {
        initializeAttendanceForToday();
        return;
    }
    attendanceData = JSON.parse(storedAttendance);
}

function initializeAttendanceForToday() {
    attendanceData = members.map(() => ({ present: false }));
    saveAttendance();
}


function renderAttendanceTable() {
    const tableBody = document.getElementById('attendanceTableBody');
    tableBody.innerHTML = '';

    const filteredMembers = members.filter(member => member.instrument === selectedInstrument); // 楽器でメンバーをフィルタリング

    filteredMembers.forEach((member, index) => { // フィルタリングされたメンバーでループ
        const row = tableBody.insertRow();
        const nameCell = row.insertCell(0);
        const presentCell = row.insertCell(1);
        const absentCell = row.insertCell(2);

        nameCell.textContent = member.name; // メンバーオブジェクトから名前を取得

        const presentRadio = document.createElement('input');
        presentRadio.type = 'radio';
        presentRadio.name = `attendance_${index}`; // indexはfilteredMembersのindex
        presentRadio.value = 'present';
        presentRadio.classList.add('attendance-checkbox');

        // attendanceDataは元のmembers配列に基づいているため、indexを調整
        const originalIndex = members.findIndex(m => m.name === member.name && m.instrument === member.instrument);
        presentRadio.checked = attendanceData[originalIndex]?.present === true; // originalIndexを使用
        presentCell.appendChild(presentRadio);

        const absentRadio = document.createElement('input');
        absentRadio.type = 'radio';
        absentRadio.name = `attendance_${index}`; // indexはfilteredMembersのindex
        absentRadio.value = 'absent';
        absentRadio.classList.add('attendance-checkbox');
        absentRadio.checked = attendanceData[originalIndex]?.present === false; // originalIndexを使用
        absentCell.appendChild(absentRadio);
    });
}


function updateAttendance() {
    const today = getFormattedDate();
    const filteredMembers = members.filter(member => member.instrument === selectedInstrument); // フィルタリングされたメンバーリストを取得
    const updatedAttendanceData = filteredMembers.map((member, index) => { // フィルタリングされたメンバーリストに基づいて出欠データを生成
        const radioNodes = document.querySelectorAll(`input[name="attendance_${index}"]`); // name属性はfilteredMembersのindexに基づいている
        let isPresent = false;
        radioNodes.forEach(radio => {
            if (radio.value === 'present' && radio.checked) {
                isPresent = true;
            }
        });
        return { present: isPresent };
    });

    // 元のattendanceDataを更新 - filteredMembersに基づいて、対応するメンバーの出欠データを更新
    filteredMembers.forEach((member, index) => {
        const originalIndex = members.findIndex(m => m.name === member.name && m.instrument === member.instrument);
        if (originalIndex !== -1) {
            attendanceData[originalIndex] = updatedAttendanceData[index]; // originalIndexを使用して更新
        }
    });


    saveAttendance();
    updateAbsentMemberList();
    alert('出欠状況を更新しました。');
}


function saveAttendance() {
    const today = getFormattedDate();
    localStorage.setItem('attendance_' + today, JSON.stringify(attendanceData));
}

function getFormattedDate() {
    const today = new Date();
    const year = today.getFullYear();
    const month = String(today.getMonth() + 1).padStart(2, '0');
    const day = String(today.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
}

function updateAbsentMemberList() {
    const absentMemberListUl = document.getElementById('absentMemberList');
    absentMemberListUl.innerHTML = '';
    let absentMembers = [];

    loadAttendance();

    members.forEach((member, index) => {
        if (attendanceData[index] && attendanceData[index].present === false) {
            absentMembers.push(member.name); // メンバーオブジェクトから名前を取得
        }
    });

    if (absentMembers.length > 0) {
        absentMembers.forEach(memberName => {
            const listItem = document.createElement('li');
            listItem.textContent = memberName;
            absentMemberListUl.appendChild(listItem);
        });
        document.getElementById('absentMemberListSection').style.display = 'block';
    } else {
        document.getElementById('absentMemberListSection').style.display = 'none';
    }
}


</script>

</body>
</html>
